# Инструкция по тестированию покупок в iOS приложении

## Изменения, которые были внесены:

### 1. **Настройка обработки покупок с listener'ом**
- Добавлен listener `_onPurchaseUpdated` в конструктор `PurchaseCubit`
- Listener автоматически обрабатывает все изменения статуса покупок
- Поддерживаются статусы: pending, error, purchased, restored

### 2. **Функция восстановления покупок**
- Добавлен метод `restorePurchases()` в `PurchaseCubit`
- Добавлена кнопка "Восстановить покупки" в UI (внизу экрана оплаты)
- При восстановлении покупки обрабатываются через тот же listener

### 3. **Улучшенное логирование**
- Добавлены подробные логи с префиксом `[PurchaseCubit]` для всех операций:
  - Загрузка продуктов
  - Процесс покупки
  - Обработка статусов покупок
  - Восстановление покупок
  - Ошибки

### 4. **Тестовый режим**
- Добавлена переменная `testMode` в `PurchaseCubit`
- Когда `testMode = true`, загружаются мок-продукты вместо реальных

## Как протестировать:

### 1. **Подготовка к тестированию на iOS:**

1. Убедитесь, что в App Store Connect настроены продукты:
   - `monthly_subscription` - месячная подписка
   - `annual_subscription` - годовая подписка
   - `lifetime_access` - пожизненный доступ

2. Создайте тестовые аккаунты в App Store Connect (Sandbox тестеры)

3. В Info.plist добавьте (если еще нет):
```xml
<key>SKAdNetworkItems</key>
<array>
  <dict>
    <key>SKAdNetworkIdentifier</key>
    <string>cstr6suwn9.skadnetwork</string>
  </dict>
</array>
```

### 2. **Запуск приложения:**

```bash
# Перейдите в корневую директорию Flutter проекта
cd [путь к корню проекта]

# Установите зависимости
flutter pub get

# Запустите на iOS симуляторе или устройстве
flutter run -d ios

# Для просмотра логов
flutter logs
```

### 3. **Тестирование покупок:**

1. **Войдите в тестовый аккаунт:**
   - Откройте Settings → App Store на устройстве
   - Выйдите из основного аккаунта
   - При первой покупке вам предложат войти - используйте Sandbox тестер

2. **Проверьте загрузку продуктов:**
   - Откройте экран оплаты
   - В логах должны появиться сообщения о загрузке продуктов
   - Проверьте, что отображаются цены и описания

3. **Протестируйте покупку:**
   - Нажмите на любую из трех кнопок покупки
   - Следите за логами - должны появиться сообщения о процессе покупки
   - Подтвердите покупку в диалоге iOS

4. **Проверьте восстановление покупок:**
   - Закройте и откройте приложение
   - Нажмите "Восстановить покупки"
   - Проверьте логи на наличие восстановленных покупок

### 4. **Возможные проблемы и решения:**

1. **"Products not found"**
   - Проверьте правильность ID продуктов
   - Убедитесь, что продукты одобрены в App Store Connect
   - Подождите несколько часов после создания продуктов

2. **"In-App Purchases not available"**
   - Проверьте подключение к интернету
   - Убедитесь, что устройство не в режиме ограничений

3. **Покупка зависает в статусе "pending"**
   - Это нормально для Sandbox - подтвердите покупку в диалоге
   - Проверьте настройки Sandbox аккаунта

### 5. **Мониторинг логов:**

Во время тестирования следите за логами. Вы должны увидеть:
```
[PurchaseCubit] Loading products...
[PurchaseCubit] In-App Purchases available
[PurchaseCubit] Products loaded: [monthly_subscription, annual_subscription, lifetime_access]
[PurchaseCubit] Starting purchase for: monthly_subscription
[PurchaseCubit] Purchase initiated successfully
[PurchaseCubit] Purchase updated: 1 items
[PurchaseCubit] Processing purchase: monthly_subscription, status: PurchaseStatus.purchased
[PurchaseCubit] Delivering product: monthly_subscription
```

## Дополнительные улучшения для production:

1. **Валидация покупок на сервере**
2. **Обработка отмененных подписок**
3. **Уведомления об истечении подписки**
4. **Аналитика покупок**
5. **A/B тестирование цен**
